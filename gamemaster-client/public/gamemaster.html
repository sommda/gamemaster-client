<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé≤ D&D Gamemaster Client - Phase 2</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f9fafb;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            height: 100vh;
            display: flex;
            background: #f3f4f6;
        }

        /* Main Chat Pane */
        .chat-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #d1d5db;
            background: white;
        }

        .chat-header {
            background: #1f2937;
            color: white;
            padding: 1rem;
            border-bottom: 1px solid #374151;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .message {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: 0.75rem;
            animation: fadeIn 0.3s ease-in;
        }

        .message.user {
            background: #dbeafe;
            margin-left: 4rem;
        }

        .message.assistant {
            background: #f3f4f6;
            margin-right: 4rem;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .avatar {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .avatar.user {
            background: #3b82f6;
            color: white;
        }

        .avatar.assistant {
            background: #10b981;
            color: white;
        }

        .message-content {
            line-height: 1.6;
        }

        .streaming-cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background: #3b82f6;
            animation: blink 1s infinite;
            margin-left: 2px;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .typing-dots {
            display: flex;
            gap: 2px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #10b981;
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite both;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        .command-badges {
            margin-top: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .command-badge {
            padding: 0.125rem 0.5rem;
            background: #e0e7ff;
            color: #3730a3;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .command-badge.dice { background: #dbeafe; color: #1e40af; }
        .command-badge.combat { background: #fee2e2; color: #dc2626; }
        .command-badge.magic { background: #f3e8ff; color: #7c3aed; }

        /* Chat Input */
        .chat-input {
            border-top: 1px solid #e5e7eb;
            background: white;
            padding: 1rem;
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .quick-action {
            padding: 0.25rem 0.75rem;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .quick-action:hover {
            background: #e5e7eb;
            transform: translateY(-1px);
        }

        .input-container {
            display: flex;
            gap: 0.75rem;
        }

        .chat-textarea {
            flex: 1;
            resize: none;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-family: inherit;
            min-height: 3rem;
            max-height: 6rem;
        }

        .send-button {
            padding: 0.75rem 1.5rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .send-button:hover:not(:disabled) {
            background: #2563eb;
        }

        .send-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        /* Character Sheet Pane */
        .character-pane {
            width: 25%;
            background: white;
            border-right: 1px solid #d1d5db;
            display: flex;
            flex-direction: column;
        }

        .character-header {
            background: #059669;
            color: white;
            padding: 1rem;
            text-align: center;
        }

        .character-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .stat-block {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-weight: 600;
            color: #374151;
        }

        .stat-value {
            color: #059669;
            font-weight: bold;
        }

        /* Tactical Map Pane */
        .tactical-pane {
            width: 20%;
            background: white;
            display: flex;
            flex-direction: column;
        }

        .tactical-header {
            background: #7c3aed;
            color: white;
            padding: 1rem;
            text-align: center;
        }

        .tactical-content {
            flex: 1;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .status-dot {
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Markdown styling */
        .message-content h1, .message-content h2, .message-content h3 {
            color: #059669;
            margin: 0.5rem 0;
        }

        .message-content strong {
            color: #dc2626;
            font-weight: 700;
        }

        .message-content em {
            color: #3b82f6;
        }

        .message-content code {
            background: #f3f4f6;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
        }

        .message-content blockquote {
            border-left: 4px solid #10b981;
            background: #ecfdf5;
            padding: 0.5rem 1rem;
            margin: 0.5rem 0;
            border-radius: 0 0.25rem 0.25rem 0;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="app-container">
            <!-- Main Chat Pane -->
            <div class="chat-pane">
                <div class="chat-header">
                    <h1>üé≤ Gamemaster Chat</h1>
                    <div class="connection-status">
                        <div class="status-dot"></div>
                        <span>Connected ‚Ä¢ AI Ready</span>
                    </div>
                </div>

                <div class="chat-history" ref="chatHistory">
                    <div v-for="message in messages" :key="message.id" 
                         :class="['message', message.role]">
                        
                        <div class="message-header">
                            <div :class="['avatar', message.role]">
                                {{ message.role === 'user' ? 'U' : 'GM' }}
                            </div>
                            <span class="font-medium">
                                {{ message.role === 'user' ? 'You' : 'Gamemaster' }}
                            </span>
                            <span class="text-gray-400 text-sm ml-auto">
                                {{ formatTime(message.timestamp) }}
                            </span>
                        </div>

                        <!-- Typing indicator for streaming -->
                        <div v-if="message.isStreaming && message.role === 'assistant'" class="typing-indicator">
                            <div class="typing-dots">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                            <span>Gamemaster is thinking...</span>
                        </div>

                        <div class="message-content" v-html="renderContent(message)"></div>

                        <!-- D&D Command badges -->
                        <div v-if="getDetectedCommands(message).length > 0" class="command-badges">
                            <span v-for="command in getDetectedCommands(message)" 
                                  :key="command" 
                                  :class="['command-badge', command]">
                                {{ command }}
                            </span>
                        </div>
                    </div>

                    <!-- Empty state -->
                    <div v-if="messages.length === 0" class="text-center py-8 text-gray-500">
                        <div class="text-6xl mb-4">üé≤</div>
                        <h3 class="text-xl font-medium mb-2">Welcome to your D&D Campaign!</h3>
                        <p class="text-sm max-w-md mx-auto">
                            Start a conversation with your AI Gamemaster. Try "roll 1d20" or "I attack the goblin"!
                        </p>
                    </div>
                </div>

                <div class="chat-input">
                    <!-- Quick Actions -->
                    <div v-if="showQuickActions" class="quick-actions">
                        <button v-for="action in quickActions" 
                                :key="action.label"
                                @click="insertQuickAction(action.text)"
                                class="quick-action">
                            {{ action.emoji }} {{ action.label }}
                        </button>
                    </div>

                    <div class="input-container">
                        <textarea v-model="currentMessage"
                                 @keydown.enter.prevent="handleSend"
                                 @keydown.shift.enter.prevent="addNewLine"
                                 @input="handleInput"
                                 class="chat-textarea"
                                 placeholder="Type your message or D&D command..."
                                 :disabled="isStreaming"
                                 ref="messageInput"></textarea>
                        
                        <button @click="handleSend"
                                :disabled="!currentMessage.trim() || isStreaming"
                                class="send-button">
                            {{ isStreaming ? 'Sending...' : '‚ö° Send' }}
                        </button>
                    </div>

                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #6b7280;">
                        Press Enter to send ‚Ä¢ Shift+Enter for new line ‚Ä¢ 
                        <button @click="showQuickActions = !showQuickActions" 
                                style="background: none; border: none; color: #3b82f6; cursor: pointer;">
                            {{ showQuickActions ? 'Hide' : 'Show' }} Quick Actions
                        </button>
                    </div>
                </div>
            </div>

            <!-- Character Sheet Pane -->
            <div class="character-pane">
                <div class="character-header">
                    <h2>üìã Character Sheet</h2>
                </div>
                <div class="character-content">
                    <div class="stat-block">
                        <h3 style="margin-bottom: 0.5rem; color: #059669;">Adventurer</h3>
                        <div class="stat-row">
                            <span class="stat-label">Level</span>
                            <span class="stat-value">3</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">HP</span>
                            <span class="stat-value">24/30</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">AC</span>
                            <span class="stat-value">16</span>
                        </div>
                    </div>

                    <div class="stat-block">
                        <h4 style="margin-bottom: 0.5rem; color: #374151;">Abilities</h4>
                        <div class="stat-row">
                            <span class="stat-label">STR</span>
                            <span class="stat-value">16 (+3)</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">DEX</span>
                            <span class="stat-value">12 (+1)</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">CON</span>
                            <span class="stat-value">14 (+2)</span>
                        </div>
                    </div>

                    <div class="stat-block">
                        <h4 style="margin-bottom: 0.5rem; color: #374151;">Equipment</h4>
                        <ul style="list-style: none; font-size: 0.9rem;">
                            <li>‚öîÔ∏è Longsword</li>
                            <li>üõ°Ô∏è Shield</li>
                            <li>üß™ Health Potion (2)</li>
                            <li>üí∞ 75 gold pieces</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Tactical Map Pane -->
            <div class="tactical-pane">
                <div class="tactical-header">
                    <h2>üó∫Ô∏è Tactical Map</h2>
                </div>
                <div class="tactical-content">
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚öîÔ∏è</div>
                        <p style="font-size: 0.9rem;">Combat map will appear here during encounters</p>
                        <div style="margin-top: 1rem; padding: 0.5rem; background: #f3f4f6; border-radius: 0.25rem; font-size: 0.8rem;">
                            <strong>Initiative Order:</strong><br>
                            1. Goblin (AC 15)<br>
                            2. Your Turn<br>
                            3. Wizard (AC 12)
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, nextTick, onMounted } = Vue;

        createApp({
            setup() {
                const messages = ref([]);
                const currentMessage = ref('');
                const isStreaming = ref(false);
                const showQuickActions = ref(true);
                const messageInput = ref(null);
                const chatHistory = ref(null);

                const quickActions = [
                    { label: 'Roll d20', text: 'roll 1d20', emoji: 'üé≤' },
                    { label: 'Initiative', text: 'roll initiative', emoji: '‚ö°' },
                    { label: 'Attack', text: 'I attack with my sword', emoji: '‚öîÔ∏è' },
                    { label: 'Perception', text: 'I make a perception check', emoji: 'üëÅÔ∏è' },
                    { label: 'Cast Spell', text: 'I cast fireball', emoji: '‚ú®' },
                    { label: 'Rest', text: 'I take a short rest', emoji: 'üò¥' }
                ];

                const addMessage = (role, content, isStreaming = false) => {
                    const message = {
                        id: Date.now() + Math.random(),
                        role,
                        content,
                        isStreaming,
                        timestamp: new Date()
                    };
                    messages.value.push(message);
                    return message;
                };

                const handleSend = async () => {
                    if (!currentMessage.value.trim() || isStreaming.value) return;

                    const userMessage = currentMessage.value.trim();
                    currentMessage.value = '';

                    // Add user message
                    addMessage('user', userMessage);

                    // Start streaming assistant response
                    const assistantMessage = addMessage('assistant', '', true);
                    isStreaming.value = true;

                    // Simulate streaming response
                    const response = generateResponse(userMessage);
                    const words = response.split(' ');
                    
                    let currentContent = '';
                    for (let i = 0; i < words.length; i++) {
                        await new Promise(resolve => setTimeout(resolve, 75));
                        currentContent += (i > 0 ? ' ' : '') + words[i];
                        assistantMessage.content = currentContent;
                        scrollToBottom();
                    }

                    assistantMessage.isStreaming = false;
                    isStreaming.value = false;
                    scrollToBottom();
                };

                const generateResponse = (message) => {
                    const lowerMessage = message.toLowerCase();
                    
                    if (lowerMessage.includes('roll') || lowerMessage.includes('d20')) {
                        const roll = Math.floor(Math.random() * 20) + 1;
                        return `üé≤ **Rolling d20...** You rolled a **${roll}**! ${roll === 20 ? 'Critical success! ‚≠ê' : roll === 1 ? 'Critical failure! üí•' : roll >= 15 ? 'Excellent result! üéâ' : roll >= 10 ? 'Good roll! ‚ú®' : 'Not great, but let\\'s see what happens... ü§î'}`;
                    }
                    
                    if (lowerMessage.includes('attack') || lowerMessage.includes('hit')) {
                        const roll = Math.floor(Math.random() * 20) + 1;
                        const damage = Math.floor(Math.random() * 8) + 1;
                        return `‚öîÔ∏è **Attack Roll:** ${roll + 3} (rolled ${roll} + 3 STR)! ${roll + 3 >= 15 ? `**Hit!** You deal **${damage} damage**. The goblin staggers back, wounded but still fighting!` : 'Miss! Your sword clangs harmlessly off the goblin\\'s armor.'}`;
                    }
                    
                    if (lowerMessage.includes('spell') || lowerMessage.includes('cast') || lowerMessage.includes('fireball')) {
                        return `‚ú® **Casting Fireball!** The magical energies swirl around your hands as you weave the incantation. A bright ball of flame erupts from your fingertips! The goblin must make a **Dexterity saving throw (DC 15)**. *Rolling...* The goblin fails! It takes **28 fire damage** and is **badly burned**! üî•`;
                    }
                    
                    if (lowerMessage.includes('perception') || lowerMessage.includes('look') || lowerMessage.includes('search')) {
                        const roll = Math.floor(Math.random() * 20) + 1;
                        return `üëÅÔ∏è **Perception Check:** ${roll + 1} (rolled ${roll} + 1 WIS). ${roll + 1 >= 12 ? 'You notice something glinting behind the old tapestry on the far wall. There might be something hidden there! üíé' : 'You scan the room but don\\'t notice anything unusual at first glance. ü§∑‚Äç‚ôÇÔ∏è'}`;
                    }
                    
                    if (lowerMessage.includes('rest') || lowerMessage.includes('sleep')) {
                        return `üò¥ **Taking a rest...** You find a safe spot to catch your breath. After an hour of rest, you recover **1d8 + 2 hit points** (rolled 6) = **8 HP restored**! You also recover one expended spell slot. Your party feels refreshed and ready to continue the adventure! ‚ú®`;
                    }
                    
                    if (lowerMessage.includes('initiative')) {
                        const roll = Math.floor(Math.random() * 20) + 1;
                        return `‚ö° **Rolling Initiative:** ${roll + 1} (rolled ${roll} + 1 DEX). ${roll + 1 >= 15 ? 'You act first! What do you do?' : 'The enemies act first, but you\\'re ready for them!'}`;
                    }
                    
                    const responses = [
                        "üé≠ **The adventure continues...** The ancient dungeon stretches before you, filled with mystery and danger. What's your next move?",
                        "‚≠ê **Great roleplay!** Your character's personality really shines through. The other party members nod in approval.",
                        "üåü **The story unfolds...** As you speak, you notice the NPC's expression change. They seem more willing to help now.",
                        "üîÆ **The magic in the air crackles...** You sense that something significant is about to happen. Roll a d20 for me!",
                        "üó°Ô∏è **Combat may be imminent...** You hear the sound of approaching footsteps echoing through the corridor."
                    ];
                    
                    return responses[Math.floor(Math.random() * responses.length)];
                };

                const insertQuickAction = (text) => {
                    currentMessage.value = text;
                    nextTick(() => {
                        messageInput.value?.focus();
                    });
                };

                const addNewLine = () => {
                    currentMessage.value += '\n';
                };

                const handleInput = () => {
                    // Auto-resize textarea
                    const textarea = messageInput.value;
                    if (textarea) {
                        textarea.style.height = 'auto';
                        textarea.style.height = Math.min(textarea.scrollHeight, 96) + 'px';
                    }
                };

                const scrollToBottom = () => {
                    nextTick(() => {
                        if (chatHistory.value) {
                            chatHistory.value.scrollTop = chatHistory.value.scrollHeight;
                        }
                    });
                };

                const formatTime = (date) => {
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                };

                const renderContent = (message) => {
                    let content = message.content;
                    
                    // Simple markdown parsing
                    content = content
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/`(.*?)`/g, '<code>$1</code>')
                        .replace(/\n/g, '<br>');
                    
                    if (message.isStreaming) {
                        content += '<span class="streaming-cursor"></span>';
                    }
                    
                    return content;
                };

                const getDetectedCommands = (message) => {
                    if (message.role !== 'user') return [];
                    
                    const content = message.content.toLowerCase();
                    const commands = [];
                    
                    if (content.includes('roll') || /\bd\d+/i.test(content)) commands.push('dice');
                    if (content.includes('attack') || content.includes('hit')) commands.push('combat');
                    if (content.includes('spell') || content.includes('cast')) commands.push('magic');
                    if (content.includes('perception') || content.includes('check')) commands.push('skill');
                    
                    return commands;
                };

                // Add welcome message
                onMounted(() => {
                    addMessage('assistant', "üé≤ **Welcome to your D&D adventure!** I'm your AI Gamemaster assistant. I can help you roll dice, manage combat, track your character, and guide your epic journey. Try saying \"roll 1d20\" or \"I attack the goblin\" to get started!");
                });

                return {
                    messages,
                    currentMessage,
                    isStreaming,
                    showQuickActions,
                    quickActions,
                    messageInput,
                    chatHistory,
                    handleSend,
                    insertQuickAction,
                    addNewLine,
                    handleInput,
                    formatTime,
                    renderContent,
                    getDetectedCommands
                };
            }
        }).mount('#app');
    </script>
</body>
</html>